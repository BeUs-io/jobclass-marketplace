import{F as c,R as v,a as h,b as p,k as r,n as o,r as u}from"./chunk-WKEOFE6Q.js";var y=(()=>{class l{constructor(){this.subscriptionSubject=new r(null),this.subscription$=this.subscriptionSubject.asObservable(),this.paymentMethodsSubject=new r([]),this.paymentMethods$=this.paymentMethodsSubject.asObservable(),this.invoicesSubject=new r([]),this.invoices$=this.invoicesSubject.asObservable(),this.activePromoCodesSubject=new r(this.getDefaultPromoCodes()),this.activePromoCodes$=this.activePromoCodesSubject.asObservable(),this.analyticsSubject=new r([]),this.analytics$=this.analyticsSubject.asObservable(),this.checkoutSessionSubject=new r(null),this.checkoutSession$=this.checkoutSessionSubject.asObservable(),this.loadSubscription(),this.loadPaymentMethods(),this.generateMockAnalytics()}initializeStripe(e){return console.log("Initializing Stripe with key:",e),o(!0).pipe(c(500))}createCheckoutSession(e,t,s,n,i){let a={id:"cs_"+Date.now(),planId:e,planName:t,amount:s,interval:n,finalAmount:s,currency:"USD",status:"pending"};if(i){let d=this.validatePromoCode(i,e,s);d&&(a.promoCode=d,a.discountAmount=this.calculateDiscount(s,d),a.finalAmount=s-a.discountAmount)}return this.checkoutSessionSubject.next(a),this.trackPlanClick(e,t),o(a).pipe(c(300))}processStripePayment(e,t,s){return o(null).pipe(c(2e3),u(()=>{let n=this.checkoutSessionSubject.value;if(!n)return{success:!1,error:"Invalid session"};let i={id:"sub_"+Date.now(),userId:"user_1",planId:n.planId,planName:n.planName,status:"active",currentPeriodStart:new Date,currentPeriodEnd:this.getNextBillingDate(n.interval),cancelAtPeriodEnd:!1,amount:n.finalAmount,currency:n.currency,interval:n.interval};return this.subscriptionSubject.next(i),this.saveSubscription(i),n.status="completed",this.checkoutSessionSubject.next(n),this.trackConversion(n.planId,n.planName,n.finalAmount),this.generateInvoice(i),{success:!0,subscription:i}}))}processPayPalPayment(e,t){return this.processStripePayment(e,"paypal_"+t,{})}validatePromoCode(e,t,s){let n=this.activePromoCodesSubject.value,i=n.find(a=>a.code.toUpperCase()===e.toUpperCase()&&a.isActive&&a.validUntil>new Date&&a.usedCount<a.maxUses&&(a.applicablePlans.length===0||a.applicablePlans.includes(t))&&(!a.minAmount||s>=a.minAmount));return i&&(i.usedCount++,this.activePromoCodesSubject.next([...n])),i||null}calculateDiscount(e,t){return t.discountType==="percentage"?Math.round(e*(t.discountValue/100)):Math.min(t.discountValue,e)}getCurrentSubscription(){return this.subscription$}cancelSubscription(e,t=!1){return o(null).pipe(c(1e3),u(()=>{let s=this.subscriptionSubject.value;return s&&s.id===e?(t?s.status="cancelled":s.cancelAtPeriodEnd=!0,this.subscriptionSubject.next(s),this.saveSubscription(s),!0):!1}))}resumeSubscription(e){return o(null).pipe(c(1e3),u(()=>{let t=this.subscriptionSubject.value;return t&&t.id===e?(t.cancelAtPeriodEnd=!1,this.subscriptionSubject.next(t),this.saveSubscription(t),!0):!1}))}updatePaymentMethod(e){return o(null).pipe(c(1e3),u(()=>{let t=this.paymentMethodsSubject.value;return t.forEach(s=>s.isDefault=s.id===e),this.paymentMethodsSubject.next([...t]),this.savePaymentMethods(t),!0}))}addPaymentMethod(e){let t=p(h({},e),{id:"pm_"+Date.now()}),s=this.paymentMethodsSubject.value;return this.paymentMethodsSubject.next([...s,t]),this.savePaymentMethods([...s,t]),o(t).pipe(c(500))}removePaymentMethod(e){let t=this.paymentMethodsSubject.value.filter(s=>s.id!==e);return this.paymentMethodsSubject.next(t),this.savePaymentMethods(t),o(!0).pipe(c(500))}getInvoices(){return this.invoices$}downloadInvoice(e){let t=this.invoicesSubject.value.find(s=>s.id===e);if(t){let s=`Invoice #${t.id}
Amount: $${t.amount}
Status: ${t.status}`,n=new Blob([s],{type:"text/plain"});return o(n).pipe(c(500))}return o(new Blob).pipe(c(500))}trackPlanView(e,t){let s=this.analyticsSubject.value,n=s.find(i=>i.planId===e);n?n.views++:s.push({planId:e,planName:t,views:1,clicks:0,conversions:0,revenue:0,conversionRate:0,averageOrderValue:0,churnRate:0,period:"month"}),this.analyticsSubject.next([...s]),this.saveAnalytics(s)}trackPlanClick(e,t){let s=this.analyticsSubject.value,n=s.find(i=>i.planId===e);n&&(n.clicks++,n.conversionRate=n.conversions/n.clicks*100),this.analyticsSubject.next([...s]),this.saveAnalytics(s)}trackConversion(e,t,s){let n=this.analyticsSubject.value,i=n.find(a=>a.planId===e);i&&(i.conversions++,i.revenue+=s,i.conversionRate=i.conversions/i.clicks*100,i.averageOrderValue=i.revenue/i.conversions),this.analyticsSubject.next([...n]),this.saveAnalytics(n)}updateCheckoutSession(e){this.checkoutSessionSubject.next(e)}getAnalytics(e="month"){return this.analytics$.pipe(u(t=>t.filter(s=>s.period===e)))}getNextBillingDate(e){let t=new Date;return e==="month"?t.setMonth(t.getMonth()+1):t.setFullYear(t.getFullYear()+1),t}generateInvoice(e){let t={id:"inv_"+Date.now(),subscriptionId:e.id,amount:e.amount,currency:e.currency,status:"paid",dueDate:new Date,paidAt:new Date,items:[{description:`${e.planName} Subscription (${e.interval}ly)`,amount:e.amount,quantity:1}]},s=this.invoicesSubject.value;this.invoicesSubject.next([t,...s]),this.saveInvoices([t,...s])}getDefaultPromoCodes(){return[{code:"WELCOME20",discountType:"percentage",discountValue:20,validUntil:new Date(Date.now()+30*24*60*60*1e3),maxUses:1e3,usedCount:142,applicablePlans:[],isActive:!0},{code:"SAVE50",discountType:"fixed",discountValue:50,validUntil:new Date(Date.now()+15*24*60*60*1e3),maxUses:500,usedCount:89,applicablePlans:["professional","enterprise"],minAmount:99,isActive:!0},{code:"STUDENT",discountType:"percentage",discountValue:50,validUntil:new Date(Date.now()+365*24*60*60*1e3),maxUses:1e4,usedCount:3421,applicablePlans:["basic"],isActive:!0}]}generateMockAnalytics(){let e=[{planId:"free",planName:"Free",views:15234,clicks:3456,conversions:2341,revenue:0,conversionRate:67.8,averageOrderValue:0,churnRate:12.3,period:"month"},{planId:"basic",planName:"Basic",views:8923,clicks:2156,conversions:523,revenue:9937,conversionRate:24.3,averageOrderValue:19,churnRate:8.5,period:"month"},{planId:"professional",planName:"Professional",views:4567,clicks:892,conversions:156,revenue:15444,conversionRate:17.5,averageOrderValue:99,churnRate:5.2,period:"month"},{planId:"enterprise",planName:"Enterprise",views:1234,clicks:234,conversions:23,revenue:11477,conversionRate:9.8,averageOrderValue:499,churnRate:2.1,period:"month"}];this.analyticsSubject.next(e)}loadSubscription(){let e=localStorage.getItem("subscription");if(e){let t=JSON.parse(e);t.currentPeriodStart=new Date(t.currentPeriodStart),t.currentPeriodEnd=new Date(t.currentPeriodEnd),t.trialEndsAt&&(t.trialEndsAt=new Date(t.trialEndsAt)),this.subscriptionSubject.next(t)}}saveSubscription(e){localStorage.setItem("subscription",JSON.stringify(e))}loadPaymentMethods(){let e=localStorage.getItem("paymentMethods");e&&this.paymentMethodsSubject.next(JSON.parse(e))}savePaymentMethods(e){localStorage.setItem("paymentMethods",JSON.stringify(e))}saveInvoices(e){localStorage.setItem("invoices",JSON.stringify(e))}saveAnalytics(e){localStorage.setItem("pricingAnalytics",JSON.stringify(e))}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=v({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{y as a};
